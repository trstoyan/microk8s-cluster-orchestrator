<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-sync-alt"></i> Live Server Sync</h2>
                    <p class="text-muted">Securely synchronize data between orchestrator instances</p>
                </div>
                <div>
                    <button class="btn btn-outline-secondary" onclick="window.location.href='{{ url_for('sync_web.index') }}'">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-plug"></i> Step 1: Connect to Remote Server</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-group">
                                <label for="remote_url">Remote Server URL</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="remote_url" 
                                       placeholder="http://10.25.8.14:5000"
                                       value="">
                                <small class="form-text text-muted">Enter the URL of the remote orchestrator server</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="remote_username">Remote Server Username</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="remote_username" 
                                       placeholder="admin"
                                       required>
                                <small class="form-text text-muted">Login username for the remote server</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="remote_password">Remote Server Password</label>
                                <input type="password" 
                                       class="form-control" 
                                       id="remote_password" 
                                       placeholder="Password"
                                       required>
                                <small class="form-text text-muted">Login password for the remote server</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary btn-lg" onclick="connectToRemote()">
                            <i class="fas fa-link"></i> Connect & Compare
                        </button>
                        <span id="connection_status" class="ml-3"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Results -->
    <div class="row mb-4" id="comparison_section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-balance-scale"></i> Step 2: Review Differences</h5>
                </div>
                <div class="card-body">
                    <!-- Summary Cards -->
                    <div class="row mb-4" id="summary_cards">
                        <!-- Will be populated by JavaScript -->
                    </div>

                    <!-- Tabs for different categories -->
                    <ul class="nav nav-tabs" id="syncTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="nodes-tab" data-toggle="tab" href="#nodes" role="tab">
                                <i class="fas fa-server"></i> Nodes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="clusters-tab" data-toggle="tab" href="#clusters" role="tab">
                                <i class="fas fa-project-diagram"></i> Clusters
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="keys-tab" data-toggle="tab" href="#keys" role="tab">
                                <i class="fas fa-key"></i> SSH Keys
                            </a>
                        </li>
                    </ul>

                    <div class="tab-content mt-3" id="syncTabContent">
                        <!-- Nodes Tab -->
                        <div class="tab-pane fade show active" id="nodes" role="tabpanel">
                            <div id="nodes_content">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Clusters Tab -->
                        <div class="tab-pane fade" id="clusters" role="tabpanel">
                            <div id="clusters_content">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- SSH Keys Tab -->
                        <div class="tab-pane fade" id="keys" role="tabpanel">
                            <div id="keys_content">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selection & Transfer -->
    <div class="row" id="transfer_section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-check-double"></i> Step 3: Select & Transfer</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                            <i class="fas fa-check-square"></i> Select All
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">
                            <i class="fas fa-square"></i> Deselect All
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="selectDifferent()">
                            <i class="fas fa-not-equal"></i> Select Different Only
                        </button>
                    </div>

                    <div id="selected_summary" class="alert alert-info">
                        <strong>Selected:</strong> <span id="selected_count">0</span> items
                    </div>

                    <button class="btn btn-success btn-lg" onclick="startSync()">
                        <i class="fas fa-sync"></i> Start Sync
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal fade" id="progressModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-sync fa-spin"></i> Live Sync Progress</h5>
                </div>
                <div class="modal-body">
                    <div class="progress mb-3" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             id="sync_progress" 
                             style="width: 0%">
                             <span id="sync_progress_text">0%</span>
                        </div>
                    </div>
                    
                    <!-- Current Status -->
                    <div class="alert alert-info mb-3" id="sync_status_alert">
                        <strong id="sync_status">🚀 Starting sync operation...</strong>
                    </div>
                    
                    <!-- Live Log Console (like Ubuntu installer) -->
                    <div class="card bg-dark text-light mb-0">
                        <div class="card-header py-2">
                            <small><i class="fas fa-terminal"></i> Live Logs</small>
                        </div>
                        <div class="card-body p-2" style="max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;" id="sync_log_container">
                            <div id="sync_logs" class="text-light">
                                <div class="text-muted">Waiting for sync to start...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="sync_close_btn" disabled>
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let comparisonData = null;
let selectedItems = {
    nodes: [],
    clusters: [],
    ssh_keys: []
};

function connectToRemote() {
    const remoteUrl = document.getElementById('remote_url').value.trim();
    const username = document.getElementById('remote_username').value.trim();
    const password = document.getElementById('remote_password').value;
    
    if (!remoteUrl) {
        showError('Please enter a remote server URL');
        return;
    }
    
    if (!username || !password) {
        showError('Please enter remote server credentials');
        return;
    }
    
    // Ensure URL has protocol and remove trailing slash
    let fullUrl = remoteUrl;
    if (!fullUrl.startsWith('http://') && !fullUrl.startsWith('https://')) {
        fullUrl = 'http://' + fullUrl;
    }
    // Remove trailing slash if present
    fullUrl = fullUrl.replace(/\/+$/, '');
    
    // Ensure port is specified (default to 5000 if missing)
    try {
        const url = new URL(fullUrl);
        if (!url.port) {
            fullUrl = `${url.protocol}//${url.hostname}:5000${url.pathname}`;
        }
    } catch (e) {
        showError('Invalid URL format');
        return;
    }
    
    updateConnectionStatus('Testing connection...', 'text-info');
    
    // Test connection first - use absolute URL
    const testUrl = fullUrl + '/api/v1/sync/test';
    console.log('[SYNC] Testing connection to:', testUrl);
    
    fetch(testUrl, {
        mode: 'cors',
        credentials: 'omit'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('[SYNC] ✅ Connection test successful:', data);
            updateConnectionStatus('Authenticating...', 'text-info');
            return compareInventories(fullUrl, username, password);
        })
        .catch(error => {
            console.error('[SYNC] Connection error:', error);
            updateConnectionStatus('Connection failed: ' + error.message, 'text-danger');
        });
}

function compareInventories(remoteUrl, username, password) {
    console.log('[SYNC] Starting comparison...');
    console.log('[SYNC] Remote URL:', remoteUrl);
    console.log('[SYNC] Username:', username);
    
    fetch('/sync/compare', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            remote_url: remoteUrl,
            username: username,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('[SYNC] Response:', data);
        
        if (data.success) {
            // Show verbose logs if available
            if (data.logs && data.logs.length > 0) {
                console.log('[SYNC] Verbose logs:');
                data.logs.forEach(log => console.log('[SYNC]', log));
            }
            
            comparisonData = data.comparison;
            displayComparison(data.comparison);
            document.getElementById('comparison_section').style.display = 'block';
            document.getElementById('transfer_section').style.display = 'block';
            updateConnectionStatus('Comparison complete!', 'text-success');
            
            // Show success message with details
            if (data.logs) {
                showInfo(data.logs.join('<br>'));
            }
        } else {
            console.error('[SYNC] Error:', data.error);
            showError(data.error);
        }
    })
    .catch(error => {
        console.error('[SYNC] Comparison failed:', error);
        showError('Comparison failed: ' + error.message);
    });
}

function displayComparison(comparison) {
    // Display summary cards
    const summaryHtml = `
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5>${comparison.summary.identical}</h5>
                    <p class="mb-0">Identical</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5>${comparison.summary.different}</h5>
                    <p class="mb-0">Different</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5>${comparison.summary.missing_on_remote}</h5>
                    <p class="mb-0">Missing on Remote</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-secondary">
                <div class="card-body">
                    <h5>${comparison.summary.missing_on_local}</h5>
                    <p class="mb-0">Missing on Local</p>
                </div>
            </div>
        </div>
    `;
    document.getElementById('summary_cards').innerHTML = summaryHtml;
    
    // Display nodes
    displayNodes(comparison.nodes);
    displayClusters(comparison.clusters);
}

function displayNodes(nodes) {
    console.log('[SYNC] Displaying nodes:', nodes);
    
    let html = '<div class="table-responsive"><table class="table table-sm table-hover">';
    html += '<thead><tr><th>Select</th><th>Hostname</th><th>IP</th><th>Status</th><th>Difference</th></tr></thead><tbody>';
    
    let hasRows = false;
    
    // Different nodes
    if (nodes.different && nodes.different.length > 0) {
        nodes.different.forEach(item => {
            hasRows = true;
            html += `
                <tr class="table-warning">
                    <td><input type="checkbox" class="node-select" data-id="${item.local.id}" onchange="updateSelection()"></td>
                    <td>${item.local.hostname}</td>
                    <td>${item.local.ip_address}</td>
                    <td><span class="badge badge-warning">Different</span></td>
                    <td><small>${item.differences.join(', ')}</small></td>
                </tr>
            `;
        });
    }
    
    // Missing on remote
    if (nodes.missing_on_remote && nodes.missing_on_remote.length > 0) {
        nodes.missing_on_remote.forEach(node => {
            hasRows = true;
            html += `
                <tr class="table-info">
                    <td><input type="checkbox" class="node-select" data-id="${node.id}" onchange="updateSelection()"></td>
                    <td>${node.hostname}</td>
                    <td>${node.ip_address}</td>
                    <td><span class="badge badge-info">Missing on Remote</span></td>
                    <td>Will be created on remote</td>
                </tr>
            `;
        });
    }
    
    // Identical nodes (show but disabled checkbox)
    if (nodes.identical && nodes.identical.length > 0) {
        nodes.identical.forEach(node => {
            hasRows = true;
            html += `
                <tr class="table-success">
                    <td><input type="checkbox" class="node-select" data-id="${node.id}" disabled></td>
                    <td>${node.hostname}</td>
                    <td>${node.ip_address || 'N/A'}</td>
                    <td><span class="badge badge-success">Identical</span></td>
                    <td><small>No sync needed</small></td>
                </tr>
            `;
        });
    }
    
    if (!hasRows) {
        html += '<tr><td colspan="5" class="text-center text-muted">No nodes found</td></tr>';
    }
    
    html += '</tbody></table></div>';
    document.getElementById('nodes_content').innerHTML = html;
}

function displayClusters(clusters) {
    console.log('[SYNC] Displaying clusters:', clusters);
    
    let html = '<div class="table-responsive"><table class="table table-sm table-hover">';
    html += '<thead><tr><th>Select</th><th>Name</th><th>Nodes</th><th>HA</th><th>Status</th></tr></thead><tbody>';
    
    let hasRows = false;
    
    // Different clusters
    if (clusters.different && clusters.different.length > 0) {
        clusters.different.forEach(item => {
            hasRows = true;
            html += `
                <tr class="table-warning">
                    <td><input type="checkbox" class="cluster-select" data-id="${item.local.id}"></td>
                    <td>${item.local.name}</td>
                    <td>${item.local.node_count || 0}</td>
                    <td>${item.local.ha_enabled ? 'Yes' : 'No'}</td>
                    <td><span class="badge badge-warning">Different</span></td>
                </tr>
            `;
        });
    }
    
    // Missing on remote
    if (clusters.missing_on_remote && clusters.missing_on_remote.length > 0) {
        clusters.missing_on_remote.forEach(cluster => {
            hasRows = true;
            html += `
                <tr class="table-info">
                    <td><input type="checkbox" class="cluster-select" data-id="${cluster.id}"></td>
                    <td>${cluster.name}</td>
                    <td>${cluster.node_count || 0}</td>
                    <td>${cluster.ha_enabled ? 'Yes' : 'No'}</td>
                    <td><span class="badge badge-info">Missing on Remote</span></td>
                </tr>
            `;
        });
    }
    
    // Identical clusters (show but disabled)
    if (clusters.identical && clusters.identical.length > 0) {
        clusters.identical.forEach(cluster => {
            hasRows = true;
            html += `
                <tr class="table-success">
                    <td><input type="checkbox" class="cluster-select" data-id="${cluster.id}" disabled></td>
                    <td>${cluster.name}</td>
                    <td>${cluster.node_count || 0}</td>
                    <td>${cluster.ha_enabled ? 'Yes' : 'No'}</td>
                    <td><span class="badge badge-success">Identical</span></td>
                </tr>
            `;
        });
    }
    
    if (!hasRows) {
        html += '<tr><td colspan="5" class="text-center text-muted">No clusters found</td></tr>';
    }
    
    html += '</tbody></table></div>';
    document.getElementById('clusters_content').innerHTML = html;
}

function updateSelection() {
    const nodeCheckboxes = document.querySelectorAll('.node-select:checked');
    const clusterCheckboxes = document.querySelectorAll('.cluster-select:checked');
    
    const total = nodeCheckboxes.length + clusterCheckboxes.length;
    document.getElementById('selected_count').textContent = total;
}

function selectAll() {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    updateSelection();
}

function deselectAll() {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateSelection();
}

function selectDifferent() {
    document.querySelectorAll('.table-warning input[type="checkbox"]').forEach(cb => cb.checked = true);
    document.querySelectorAll('.table-info input[type="checkbox"]').forEach(cb => cb.checked = true);
    updateSelection();
}

async function startSync() {
    console.log('[SYNC] Starting sync operation...');
    
    // Get selected items
    const selectedNodes = Array.from(document.querySelectorAll('.node-select:checked:not(:disabled)')).map(cb => cb.dataset.id);
    const selectedClusters = Array.from(document.querySelectorAll('.cluster-select:checked:not(:disabled)')).map(cb => cb.dataset.id);
    
    if (selectedNodes.length === 0 && selectedClusters.length === 0) {
        showError('Please select at least one item to sync');
        return;
    }
    
    console.log('[SYNC] Selected items:', { nodes: selectedNodes.length, clusters: selectedClusters.length });
    
    // Show progress modal using vanilla JavaScript
    const progressModal = document.getElementById('progressModal');
    const modal = new bootstrap.Modal(progressModal);
    modal.show();
    
    // Start listening to progress logs
    startProgressStream();
    
    const remoteUrl = document.getElementById('remote_url').value.trim();
    const remoteUsername = document.getElementById('remote_username').value.trim();
    const remotePassword = document.getElementById('remote_password').value;
    
    try {
        const response = await fetch('/sync/api/transfer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                remote_url: remoteUrl,
                remote_username: remoteUsername,
                remote_password: remotePassword,
                selected_items: {
                    nodes: selectedNodes,
                    clusters: selectedClusters
                }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            updateSyncProgress(100, '✅ Sync completed successfully!');
            
            // Enable close button
            const closeBtn = document.getElementById('sync_close_btn');
            if (closeBtn) {
                closeBtn.disabled = false;
                closeBtn.onclick = function() {
                    // Close stream if still open
                    if (window.syncProgressStream) {
                        window.syncProgressStream.close();
                    }
                    modal.hide();
                    showSuccess('Sync completed! Items transferred successfully.');
                    // Refresh the comparison
                    compareServers();
                };
            }
        } else {
            updateSyncProgress(0, '❌ Sync failed: ' + result.error);
            addLogEntry({
                timestamp: new Date().toLocaleTimeString(),
                level: 'error',
                message: 'Sync failed: ' + result.error
            });
            
            // Enable close button
            const closeBtn = document.getElementById('sync_close_btn');
            if (closeBtn) {
                closeBtn.disabled = false;
                closeBtn.onclick = function() {
                    if (window.syncProgressStream) {
                        window.syncProgressStream.close();
                    }
                    modal.hide();
                    showError('Sync failed: ' + result.error);
                };
            }
        }
    } catch (error) {
        console.error('[SYNC] Error during sync:', error);
        updateSyncProgress(0, '❌ Error: ' + error.message);
        addLogEntry({
            timestamp: new Date().toLocaleTimeString(),
            level: 'error',
            message: 'Sync error: ' + error.message
        });
        
        // Enable close button on error
        const closeBtn = document.getElementById('sync_close_btn');
        if (closeBtn) {
            closeBtn.disabled = false;
            closeBtn.onclick = function() {
                if (window.syncProgressStream) {
                    window.syncProgressStream.close();
                }
                modal.hide();
                showError('Sync error: ' + error.message);
            };
        }
    }
}

function updateSyncProgress(percent, message) {
    const progressBar = document.getElementById('sync_progress');
    const progressText = document.getElementById('sync_progress_text');
    const statusText = document.getElementById('sync_status');
    
    if (progressBar) {
        progressBar.style.width = percent + '%';
    }
    
    if (progressText) {
        progressText.textContent = percent + '%';
    }
    
    if (statusText) {
        statusText.innerHTML = message;
    }
}

function addLogEntry(log) {
    const logsContainer = document.getElementById('sync_logs');
    
    // Create log entry
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry mb-1';
    
    // Color based on level
    let textClass = 'text-light';
    if (log.level === 'success') textClass = 'text-success';
    else if (log.level === 'error') textClass = 'text-danger';
    else if (log.level === 'warning') textClass = 'text-warning';
    else if (log.level === 'info') textClass = 'text-info';
    
    logEntry.innerHTML = `<span class="text-muted">[${log.timestamp}]</span> <span class="${textClass}">${log.message}</span>`;
    
    logsContainer.appendChild(logEntry);
    
    // Auto-scroll to bottom
    const logContainer = document.getElementById('sync_log_container');
    logContainer.scrollTop = logContainer.scrollHeight;
}

function startProgressStream() {
    console.log('[SYNC] Starting progress stream...');
    
    // Clear previous logs
    const logsContainer = document.getElementById('sync_logs');
    logsContainer.innerHTML = '';
    
    // Disable close button until done
    const closeBtn = document.getElementById('sync_close_btn');
    if (closeBtn) {
        closeBtn.disabled = true;
    }
    
    // Use EventSource for Server-Sent Events
    const eventSource = new EventSource('/sync/api/progress-stream');
    
    eventSource.onmessage = function(event) {
        const log = JSON.parse(event.data);
        console.log('[SYNC-PROGRESS]', log);
        
        // Add log entry to console
        addLogEntry(log);
        
        // Update current status alert
        const statusText = document.getElementById('sync_status');
        const statusAlert = document.getElementById('sync_status_alert');
        if (statusText) {
            const icon = log.level === 'error' ? '❌' : 
                        log.level === 'success' ? '✅' : 
                        log.level === 'warning' ? '⚠️' : 'ℹ️';
            statusText.innerHTML = `${icon} ${log.message}`;
            
            // Update alert color based on status
            if (statusAlert) {
                statusAlert.className = 'alert mb-3';
                if (log.level === 'error') {
                    statusAlert.classList.add('alert-danger');
                } else if (log.level === 'success') {
                    statusAlert.classList.add('alert-success');
                } else if (log.level === 'warning') {
                    statusAlert.classList.add('alert-warning');
                } else {
                    statusAlert.classList.add('alert-info');
                }
            }
        }
        
        // Update progress bar based on keywords
        if (log.message.includes('Preparing') || log.message.includes('Starting')) {
            updateSyncProgress(10, log.message);
        } else if (log.message.includes('Connecting') || log.message.includes('Login')) {
            updateSyncProgress(20, log.message);
        } else if (log.message.includes('Fetching') || log.message.includes('Prepared')) {
            updateSyncProgress(40, log.message);
        } else if (log.message.includes('Transferring')) {
            updateSyncProgress(60, log.message);
        } else if (log.message.includes('transferred')) {
            updateSyncProgress(80, log.message);
        } else if (log.message.includes('completed') || log.message.includes('Complete')) {
            updateSyncProgress(100, log.message);
            
            // Enable close button when done
            if (closeBtn) {
                closeBtn.disabled = false;
            }
        }
    };
    
    eventSource.onerror = function(error) {
        console.log('[SYNC] Progress stream closed or error:', error);
        eventSource.close();
        
        // Enable close button on error
        if (closeBtn) {
            closeBtn.disabled = false;
        }
    };
    
    // Store reference to close later
    window.syncProgressStream = eventSource;
}

function updateConnectionStatus(message, className) {
    const status = document.getElementById('connection_status');
    status.innerHTML = `<span class="${className}"><i class="fas fa-circle"></i> ${message}</span>`;
}

function showError(message) {
    console.error('[SYNC] Error:', message);
    alert('Error: ' + message);
}

function showSuccess(message) {
    console.log('[SYNC] Success:', message);
    alert(message);
}

function showInfo(message) {
    console.log('[SYNC] Info:', message);
    // Could use a toast notification here instead of alert
}
</script>
