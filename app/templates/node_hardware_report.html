{% extends "base.html" %}

{% block title %}Hardware Report - {{ node.hostname }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1><i class="fas fa-server"></i> {{ node.hostname }}</h1>
                    <p class="text-muted">Detailed Hardware Report</p>
                </div>
                <div>
                    <a href="{{ url_for('web.hardware_report') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to All Nodes
                    </a>
                    <button class="btn btn-primary" onclick="collectNodeHardwareReport({{ node.id }})">
                        <i class="fas fa-sync-alt"></i> Update Report
                    </button>
                </div>
            </div>

            <!-- Basic Info -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">System Information</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-borderless">
                                <tr><th>Hostname:</th><td>{{ node.hostname }}</td></tr>
                                <tr><th>IP Address:</th><td>{{ node.ip_address }}</td></tr>
                                <tr><th>Status:</th><td><span class="badge badge-{{ 'success' if node.status == 'online' else 'secondary' }}">{{ node.status }}</span></td></tr>
                                <tr><th>OS Version:</th><td>{{ node.os_version or 'Unknown' }}</td></tr>
                                <tr><th>Kernel:</th><td>{{ node.kernel_version or 'Unknown' }}</td></tr>
                                <tr><th>Last Seen:</th><td>{{ node.last_seen.strftime('%Y-%m-%d %H:%M:%S') if node.last_seen else 'Never' }}</td></tr>
                                {% if node.cluster %}
                                <tr><th>Cluster:</th><td><a href="{{ url_for('web.cluster_hardware_report', cluster_id=node.cluster.id) }}">{{ node.cluster.name }}</a></td></tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">Resource Usage</h6>
                        </div>
                        <div class="card-body">
                            {% if node.cpu_usage_percent is not none or node.memory_usage_percent is not none or node.disk_usage_percent is not none %}
                            <div class="mb-3">
                                <label>CPU Usage</label>
                                <div class="progress">
                                    <div class="progress-bar" style="width: {{ node.cpu_usage_percent or 0 }}%">
                                        {{ node.cpu_usage_percent or 0 }}%
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label>Memory Usage</label>
                                <div class="progress">
                                    <div class="progress-bar bg-info" style="width: {{ node.memory_usage_percent or 0 }}%">
                                        {{ node.memory_usage_percent or 0 }}%
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label>Disk Usage</label>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" style="width: {{ node.disk_usage_percent or 0 }}%">
                                        {{ node.disk_usage_percent or 0 }}%
                                    </div>
                                </div>
                            </div>
                            {% if node.load_average %}
                            <p><strong>Load Average:</strong> {{ node.load_average }}</p>
                            {% endif %}
                            {% if node.uptime_seconds %}
                            <p><strong>Uptime:</strong> {{ "%.1f"|format(node.uptime_seconds / 86400) }} days</p>
                            {% endif %}
                            {% else %}
                            <p class="text-muted">No usage data available. Click "Update Report" to collect current data.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hardware Details -->
            <div class="row mb-4">
                <!-- CPU Information -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-microchip"></i> CPU Information</h6>
                        </div>
                        <div class="card-body">
                            {% if parsed_info.cpu %}
                            <table class="table table-sm table-borderless">
                                <tr><th>Model:</th><td>{{ parsed_info.cpu.model or 'Unknown' }}</td></tr>
                                <tr><th>Architecture:</th><td>{{ parsed_info.cpu.architecture or 'Unknown' }}</td></tr>
                                <tr><th>Cores:</th><td>{{ parsed_info.cpu.cores or node.cpu_cores or 'Unknown' }}</td></tr>
                                <tr><th>Threads:</th><td>{{ parsed_info.cpu.threads or 'Unknown' }}</td></tr>
                                <tr><th>Frequency:</th><td>{{ parsed_info.cpu.frequency or 'Unknown' }}</td></tr>
                                {% if parsed_info.cpu.cache_info %}
                                <tr><th>Cache:</th><td><small>{{ parsed_info.cpu.cache_info }}</small></td></tr>
                                {% endif %}
                                {% if parsed_info.cpu.usage_percent is not none %}
                                <tr><th>Current Usage:</th><td>{{ parsed_info.cpu.usage_percent }}%</td></tr>
                                {% endif %}
                            </table>
                            {% else %}
                            <p class="text-muted">No detailed CPU information available.</p>
                            <p><strong>Cores:</strong> {{ node.cpu_cores or 'Unknown' }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Memory Information -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-memory"></i> Memory Information</h6>
                        </div>
                        <div class="card-body">
                            {% if parsed_info.memory %}
                            <table class="table table-sm table-borderless">
                                <tr><th>Total:</th><td>{{ parsed_info.memory.total_human or (node.memory_gb ~ ' GB') or 'Unknown' }}</td></tr>
                                <tr><th>Total GB:</th><td>{{ parsed_info.memory.total_gb or node.memory_gb or 'Unknown' }}</td></tr>
                                {% if parsed_info.memory.usage_percent is not none %}
                                <tr><th>Current Usage:</th><td>{{ parsed_info.memory.usage_percent }}%</td></tr>
                                {% endif %}
                                {% if parsed_info.memory.swap_info %}
                                <tr><th>Swap:</th><td><small>{{ parsed_info.memory.swap_info }}</small></td></tr>
                                {% endif %}
                            </table>
                            {% if parsed_info.memory.details %}
                            <div class="mt-3">
                                <strong>Memory Details:</strong>
                                <pre class="small bg-light p-2 mt-2">{{ parsed_info.memory.details }}</pre>
                            </div>
                            {% endif %}
                            {% else %}
                            <p class="text-muted">No detailed memory information available.</p>
                            <p><strong>Total:</strong> {{ node.memory_gb or 'Unknown' }} GB</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <!-- Disk Information -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-hdd"></i> Storage Information</h6>
                        </div>
                        <div class="card-body">
                            {% if parsed_info.disk %}
                            <table class="table table-sm table-borderless">
                                <tr><th>Total:</th><td>{{ parsed_info.disk.total_gb or node.disk_gb or 'Unknown' }} GB</td></tr>
                                {% if parsed_info.disk.usage_percent is not none %}
                                <tr><th>Current Usage:</th><td>{{ parsed_info.disk.usage_percent }}%</td></tr>
                                {% endif %}
                            </table>
                            {% if parsed_info.disk.layout %}
                            <div class="mt-3">
                                <strong>Disk Layout:</strong>
                                <pre class="small bg-light p-2 mt-2">{{ parsed_info.disk.layout }}</pre>
                            </div>
                            {% endif %}
                            {% if parsed_info.disk.details %}
                            <div class="mt-3">
                                <strong>Disk Details:</strong>
                                <pre class="small bg-light p-2 mt-2">{{ parsed_info.disk.details }}</pre>
                            </div>
                            {% endif %}
                            {% else %}
                            <p class="text-muted">No detailed disk information available.</p>
                            <p><strong>Total:</strong> {{ node.disk_gb or 'Unknown' }} GB</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- GPU Information -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-tv"></i> GPU Information</h6>
                        </div>
                        <div class="card-body">
                            {% if parsed_info.gpu %}
                            <table class="table table-sm table-borderless">
                                <tr><th>GPU Present:</th><td>
                                    {% if parsed_info.gpu.present %}
                                        <span class="badge badge-success">Yes</span>
                                    {% else %}
                                        <span class="badge badge-secondary">No</span>
                                    {% endif %}
                                </td></tr>
                            </table>
                            {% if parsed_info.gpu.details %}
                            <div class="mt-3">
                                <strong>GPU Details:</strong>
                                <pre class="small bg-light p-2 mt-2">{{ parsed_info.gpu.details }}</pre>
                            </div>
                            {% endif %}
                            {% else %}
                            <p class="text-muted">No GPU information available.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <!-- Network Information -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-network-wired"></i> Network Information</h6>
                        </div>
                        <div class="card-body">
                            {% if parsed_info.network %}
                            {% if parsed_info.network.interfaces %}
                            <table class="table table-sm table-borderless">
                                <tr><th>Interfaces:</th><td>{{ parsed_info.network.interfaces | length }}</td></tr>
                                <tr><th>Interface List:</th><td>{{ parsed_info.network.interfaces | join(', ') }}</td></tr>
                            </table>
                            {% endif %}
                            {% if parsed_info.network.details %}
                            <div class="mt-3">
                                <strong>Network Details:</strong>
                                <pre class="small bg-light p-2 mt-2" style="max-height: 300px; overflow-y: auto;">{{ parsed_info.network.details }}</pre>
                            </div>
                            {% endif %}
                            {% else %}
                            <p class="text-muted">No detailed network information available.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Temperature Information -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-thermometer-half"></i> Temperature Information</h6>
                        </div>
                        <div class="card-body">
                            {% if parsed_info.thermal %}
                            <table class="table table-sm table-borderless">
                                <tr><th>Sensors Available:</th><td>
                                    {% if parsed_info.thermal.sensors_available %}
                                        <span class="badge badge-success">Yes</span>
                                    {% else %}
                                        <span class="badge badge-secondary">No</span>
                                    {% endif %}
                                </td></tr>
                            </table>
                            {% if parsed_info.thermal.details %}
                            <div class="mt-3">
                                <strong>Temperature Details:</strong>
                                <pre class="small bg-light p-2 mt-2">{{ parsed_info.thermal.details }}</pre>
                            </div>
                            {% endif %}
                            {% else %}
                            <p class="text-muted">No temperature sensor information available.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hardware General Information -->
            {% if parsed_info.hardware %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-cogs"></i> Hardware Details</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-borderless">
                                {% if parsed_info.hardware.manufacturer %}
                                <tr><th>Manufacturer:</th><td>{{ parsed_info.hardware.manufacturer }}</td></tr>
                                {% endif %}
                                {% if parsed_info.hardware.model %}
                                <tr><th>Model:</th><td>{{ parsed_info.hardware.model }}</td></tr>
                                {% endif %}
                                {% if parsed_info.hardware.serial %}
                                <tr><th>Serial Number:</th><td>{{ parsed_info.hardware.serial }}</td></tr>
                                {% endif %}
                                {% if parsed_info.hardware.bios_version %}
                                <tr><th>BIOS Version:</th><td>{{ parsed_info.hardware.bios_version }}</td></tr>
                                {% endif %}
                            </table>
                            {% if parsed_info.hardware.devices_summary %}
                            <div class="mt-3">
                                <strong>Connected Devices:</strong>
                                <pre class="small bg-light p-2 mt-2">{{ parsed_info.hardware.devices_summary }}</pre>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function collectNodeHardwareReport(nodeId) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    button.disabled = true;
    
    fetch('/api/hardware-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({node_id: nodeId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('Hardware report collection started. Operation ID: ' + data.operation_id + '\n\nThe page will reload in a few seconds to show updated data.');
            setTimeout(() => location.reload(), 3000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error collecting hardware report');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
</script>
{% endblock %}
