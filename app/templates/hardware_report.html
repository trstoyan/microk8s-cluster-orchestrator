{% extends "base.html" %}

{% block title %}Hardware Report{% endblock %}

{% block header %}Hardware Report{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <div class="col-12 d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="bi bi-cpu"></i> Hardware Report</h1>
                <div>
                    <button class="btn btn-primary" onclick="collectHardwareReport()">
                        <i class="bi bi-arrow-clockwise"></i> Update Hardware Report
                    </button>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/api/hardware-report" target="_blank"><i class="bi bi-filetype-json"></i> JSON</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                    <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Nodes</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ summary.total_nodes }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-server fs-1 text-muted"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">CPU Cores</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ summary.total_cpu_cores }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-cpu fs-1 text-muted"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Total RAM</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ "%.1f"|format(summary.total_memory_gb) }} GB</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-memory fs-1 text-muted"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Total Storage</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ "%.1f"|format(summary.total_disk_gb) }} GB</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-device-hdd fs-1 text-muted"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                    <div class="card border-left-secondary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">GPU Nodes</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ summary.nodes_with_gpu }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-gpu-card fs-1 text-muted"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                    <div class="card border-left-dark shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-dark text-uppercase mb-1">Thermal Sensors</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ summary.nodes_with_thermal }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-thermometer-half fs-1 text-muted"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Usage Overview -->
            {% if summary.nodes_with_usage_data > 0 %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Resource Usage Overview</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h5>CPU Usage</h5>
                                    <div class="progress mb-3">
                                        <div class="progress-bar" role="progressbar" style="width: {{ summary.avg_cpu_usage }}%">
                                            {{ summary.avg_cpu_usage }}%
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h5>Memory Usage</h5>
                                    <div class="progress mb-3">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ summary.avg_memory_usage }}%">
                                            {{ summary.avg_memory_usage }}%
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h5>Disk Usage</h5>
                                    <div class="progress mb-3">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: {{ summary.avg_disk_usage }}%">
                                            {{ summary.avg_disk_usage }}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Nodes Table -->
            <div class="card shadow flex-fill">
                <div class="card-header">
                    <h5 class="mb-0 fw-bold text-primary">Node Hardware Details</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="table-responsive flex-fill" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-hover" id="hardwareTable">
                            <thead class="sticky-top bg-white">
                                <tr>
                                    <th>Node</th>
                                    <th>Cluster</th>
                                    <th>CPU</th>
                                    <th>Memory</th>
                                    <th>Storage</th>
                                    <th>GPU</th>
                                    <th>Temperature</th>
                                    <th>Usage</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if nodes %}
                                {% for node in nodes %}
                                <tr>
                                    <td>
                                        <strong>{{ node.hostname }}</strong><br>
                                        <small class="text-muted">{{ node.ip_address }}</small><br>
                                        <span class="badge bg-{{ 'success' if node.status == 'online' else 'secondary' }}">
                                            {{ node.status }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if node.cluster %}
                                            <a href="{{ url_for('web.cluster_hardware_report', cluster_id=node.cluster.id) }}">
                                                {{ node.cluster.name }}
                                            </a>
                                        {% else %}
                                            <span class="text-muted">No cluster</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if node.cpu_cores %}
                                            <strong>{{ node.cpu_cores }}</strong> cores<br>
                                            {% if node.cpu_usage_percent is not none %}
                                                <div class="progress progress-sm">
                                                    <div class="progress-bar" style="width: {{ node.cpu_usage_percent }}%"></div>
                                                </div>
                                                <small>{{ node.cpu_usage_percent }}% used</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if node.memory_gb %}
                                            <strong>{{ "%.1f"|format(node.memory_gb) }}</strong> GB<br>
                                            {% if node.memory_usage_percent is not none %}
                                                <div class="progress progress-sm">
                                                    <div class="progress-bar bg-info" style="width: {{ node.memory_usage_percent }}%"></div>
                                                </div>
                                                <small>{{ node.memory_usage_percent }}% used</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if node.disk_gb %}
                                            <strong>{{ "%.1f"|format(node.disk_gb) }}</strong> GB<br>
                                            {% if node.disk_usage_percent is not none %}
                                                <div class="progress progress-sm">
                                                    <div class="progress-bar bg-warning" style="width: {{ node.disk_usage_percent }}%"></div>
                                                </div>
                                                <small>{{ node.disk_usage_percent }}% used</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if node.gpu_info and 'present": true' in node.gpu_info.lower() %}
                                            <span class="badge bg-success">Present</span>
                                        {% else %}
                                            <span class="badge bg-secondary">None</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if node.thermal_info and 'sensors_available": true' in node.thermal_info.lower() %}
                                            <span class="badge bg-success">Available</span>
                                        {% else %}
                                            <span class="badge bg-secondary">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if node.load_average %}
                                            <small>Load: {{ node.load_average }}</small><br>
                                        {% endif %}
                                        {% if node.uptime_seconds %}
                                            <small>Uptime: {{ "%.1f"|format(node.uptime_seconds / 86400) }} days</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if node.last_seen %}
                                            {{ node.last_seen.strftime('%Y-%m-%d %H:%M') }}
                                        {% else %}
                                            <span class="text-muted">Never</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{{ url_for('web.node_hardware_report', node_id=node.id) }}" 
                                               class="btn btn-outline-primary" title="Detailed Report">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <button onclick="collectNodeHardwareReport({{ node.id }})" 
                                                    class="btn btn-outline-secondary" title="Update Node Hardware">
                                                <i class="bi bi-arrow-clockwise"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="10" class="text-center py-5">
                                        <i class="bi bi-server fs-1 text-muted"></i>
                                        <h4 class="mt-3">No Nodes Found</h4>
                                        <p class="text-muted">Add nodes to your cluster to see hardware information here.</p>
                                        <a href="{{ url_for('web.add_node') }}" class="btn btn-primary">
                                            <i class="bi bi-plus"></i> Add Your First Node
                                        </a>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function collectHardwareReport() {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Collecting...';
    button.disabled = true;
    
    fetch('/api/hardware-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error collecting hardware report: ' + data.error);
        } else {
            alert('Hardware report collection started successfully!\n\nOperation ID: ' + data.operation_id + '\n\nThe page will refresh in a few seconds to show updated data.');
            setTimeout(() => location.reload(), 3000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error collecting hardware report');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function collectNodeHardwareReport(nodeId) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
    button.disabled = true;
    
    fetch('/api/hardware-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({node_id: nodeId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error collecting node hardware: ' + data.error);
        } else {
            alert('Hardware collection started for this node!\n\nOperation ID: ' + data.operation_id + '\n\nThe page will refresh in a few seconds to show updated data.');
            setTimeout(() => location.reload(), 3000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error collecting hardware report');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
</script>
{% endblock %}
