# /etc/hosts Configuration Guide

## Overview

The `/etc/hosts` configuration feature is essential for MicroK8s High Availability (HA) clusters. It automatically configures hostname-to-IP mappings on all cluster nodes to ensure proper cluster communication.

## Why /etc/hosts Configuration is Important

### 1. DNS Resolution Issues
- Kubernetes components need to resolve each other's hostnames
- If DNS fails, `/etc/hosts` provides fallback resolution
- Prevents "hostname not found" errors

### 2. MicroK8s HA Requirements
- Master nodes need to communicate with each other
- Worker nodes need to reach master nodes
- etcd cluster members need to find each other

### 3. Required /etc/hosts Entries
For a cluster with nodes `node-01`, `node-02`, `node-03` with IPs `192.168.1.10`, `192.168.1.11`, `192.168.1.12`:

```
# MicroK8s cluster entries - Auto-generated by cluster orchestrator
192.168.1.10 node-01
192.168.1.11 node-02
192.168.1.12 node-03
# End MicroK8s cluster entries
```

## Features

### ✅ Automatic Configuration
- Configures `/etc/hosts` on all cluster nodes simultaneously
- Uses Ansible for reliable, parallel execution
- Validates SSH connections before proceeding

### ✅ Safety Features
- **Backup**: Creates timestamped backups of original `/etc/hosts` files
- **Verification**: Tests hostname resolution after configuration
- **DNS Testing**: Verifies DNS resolution for all nodes
- **Duplicate Detection**: Warns about duplicate entries

### ✅ Multiple Interfaces
- **CLI**: Command-line interface with confirmation prompts
- **Web UI**: Browser-based interface with one-click operation
- **REST API**: Programmatic access for automation

## Usage

### Command Line Interface (CLI)

```bash
# Configure /etc/hosts for a cluster
microk8s-cluster cluster configure-hosts <cluster_id>

# Example
microk8s-cluster cluster configure-hosts 1
```

**CLI Features:**
- Interactive confirmation prompt
- Shows nodes that will be configured
- Displays backup information
- Provides operation ID for tracking

### Web Interface

1. Navigate to the cluster detail page
2. Click the "Actions" dropdown menu
3. Select "Configure /etc/hosts"
4. Confirm the operation in the dialog

**Web Interface Features:**
- Visual confirmation dialog with operation details
- Automatic page refresh after operation
- Flash messages for success/error feedback
- Operation tracking through operations page

### REST API

```bash
# Configure /etc/hosts via API
curl -X POST \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  http://localhost:5000/api/clusters/1/configure-hosts
```

**API Response:**
```json
{
  "operation": {
    "id": 123,
    "operation_type": "configure",
    "operation_name": "Configure /etc/hosts",
    "status": "pending",
    "created_at": "2024-01-15T10:30:00Z"
  },
  "message": "Hosts file configuration started for cluster my-cluster",
  "nodes_count": 3,
  "nodes": [
    {"hostname": "node-01", "ip_address": "192.168.1.10"},
    {"hostname": "node-02", "ip_address": "192.168.1.11"},
    {"hostname": "node-03", "ip_address": "192.168.1.12"}
  ]
}
```

## How It Works

### 1. Pre-flight Checks
- Validates SSH connections to all nodes
- Ensures cluster has assigned nodes
- Checks SSH key availability

### 2. Backup Creation
- Creates timestamped backup of original `/etc/hosts`
- Stores backup in `/tmp/hosts_backups/`
- Preserves original file permissions

### 3. Configuration Process
- Filters out existing cluster entries
- Generates new cluster hostname mappings
- Writes updated `/etc/hosts` file
- Maintains file permissions (0644)

### 4. Verification
- Tests hostname resolution with `getent hosts`
- Performs DNS resolution tests with `nslookup`
- Checks for duplicate entries
- Validates file syntax

### 5. Reporting
- Creates detailed configuration summary
- Reports success/failure for each node
- Provides backup file locations
- Logs verification results

## Ansible Playbook Details

The feature uses the `configure_hosts_file.yml` Ansible playbook with the following tasks:

1. **Backup Creation**: Creates backup directory and backs up original files
2. **Content Analysis**: Reads and filters current `/etc/hosts` content
3. **Entry Generation**: Creates cluster hostname mappings
4. **File Update**: Writes new `/etc/hosts` file with backup
5. **Verification**: Tests hostname resolution for all nodes
6. **DNS Testing**: Performs DNS resolution tests
7. **Duplicate Check**: Identifies and reports duplicate entries
8. **Summary Report**: Creates detailed configuration report

## Troubleshooting

### Common Issues

#### SSH Connection Failures
```
Error: SSH connection validation failed
```
**Solution**: Ensure SSH keys are properly configured and tested for all nodes.

#### Permission Denied
```
Error: Permission denied writing to /etc/hosts
```
**Solution**: Ensure the SSH user has sudo privileges on all nodes.

#### DNS Resolution Failures
```
Warning: DNS resolution failed for node-01
```
**Solution**: Check network connectivity and DNS server configuration.

### Recovery

If configuration fails or causes issues:

1. **Restore from Backup**:
   ```bash
   # On each node, restore from backup
   sudo cp /tmp/hosts_backups/hosts_node-01_<timestamp> /etc/hosts
   ```

2. **Manual Cleanup**:
   ```bash
   # Remove cluster entries manually
   sudo sed -i '/# MicroK8s cluster entries/,/# End MicroK8s cluster entries/d' /etc/hosts
   ```

3. **Re-run Configuration**:
   ```bash
   # Re-run the configuration
   microk8s-cluster cluster configure-hosts <cluster_id>
   ```

## Best Practices

### 1. Pre-Configuration
- Ensure all nodes are online and accessible
- Test SSH connections manually
- Verify network connectivity between nodes

### 2. During Configuration
- Monitor the operation through the operations page
- Check backup files are created successfully
- Verify no duplicate entries exist

### 3. Post-Configuration
- Test cluster communication manually
- Verify MicroK8s services can resolve hostnames
- Monitor cluster health after configuration

### 4. Maintenance
- Re-run configuration when adding new nodes
- Update configuration after IP address changes
- Regular verification of hostname resolution

## Security Considerations

### File Permissions
- `/etc/hosts` files are set to 0644 (readable by all)
- Backup files preserve original permissions
- SSH keys remain secure and unchanged

### Network Security
- Configuration only adds hostname mappings
- No network services are modified
- No firewall rules are changed

### Access Control
- Requires SSH access to all nodes
- Uses existing SSH key authentication
- Respects user permissions and sudo access

## Integration with Other Features

### Cluster Setup
- Can be run before or after cluster setup
- Recommended to run before enabling HA mode
- Integrates with cluster health monitoring

### Node Management
- Automatically includes all cluster nodes
- Updates when nodes are added/removed
- Maintains consistency across cluster

### Monitoring
- Operation tracking through operations system
- Integration with cluster health scoring
- Detailed logging for troubleshooting

## Support

For issues or questions:

1. Check the operations page for detailed error messages
2. Review Ansible logs in the `logs/` directory
3. Verify SSH connectivity and permissions
4. Check network connectivity between nodes
5. Review backup files for manual recovery

## Related Documentation

- [MicroK8s HA Setup Guide](LONGHORN_SETUP_GUIDE.md)
- [SSH Key Management Guide](SSH_KEY_MANAGEMENT_GUIDE.md)
- [Cluster Operations Guide](README.md)
- [Troubleshooting Guide](README.md#troubleshooting)
